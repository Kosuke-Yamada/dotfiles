# ==============================================================================
# tmux configuration
# Zellij風のキーバインド設定
# ==============================================================================

# ------------------------------------------------------------------------------
# 基本設定
# ------------------------------------------------------------------------------

# prefixキーをCtrl+Spaceに変更（Zellijスタイルでは主にCtrl+キーでモード切替）
set -g prefix C-Space
unbind C-b
bind C-Space send-prefix

# 256色対応
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",*256col*:Tc"

# マウス有効化
set -g mouse on

# ウィンドウ・ペインのインデックスを1から開始
set -g base-index 1
setw -g pane-base-index 1

# ウィンドウを閉じたときに番号を詰める
set -g renumber-windows on

# スクロールバックバッファサイズ
set -g history-limit 50000

# escapeキーの遅延を無効化
set -sg escape-time 0

# ウィンドウタイトルの自動更新
set -g set-titles on

# ウィンドウ名を自動的に現在のディレクトリ名に設定
set -g automatic-rename on
set -g automatic-rename-format "#{b:pane_current_path}"

# フォーカスイベントを有効化
set -g focus-events on

# デフォルトシェル
set -g default-shell /bin/zsh

# ペインボーダーのスタイル
set -g pane-border-style fg=#b5bd68
set -g pane-active-border-style fg=#b5bd68

# ------------------------------------------------------------------------------
# ステータスバー（2行：上=パス、下=タブ+ヘルプ）
# ------------------------------------------------------------------------------
set -g status 2
set -g status-position bottom
set -g status-style bg=colour235,fg=colour250
set -g status-interval 1

# 上段（status-format[0]）：現在のパス
set -g status-format[0] "#[align=left,bg=colour235,fg=colour245] #[fg=#b5bd68]#{pane_current_path}"

# 下段（status-format[1]）：セッション名 + タブ + ヘルプ
# ヘルプは現在のkey-tableまたはcopy-modeに応じて動的に変更
set -g status-format[1] "\
#[align=left,bg=colour235]\
#[range=left]#[fg=#b5bd68,bold] [#S] #[norange]\
#{W:#[range=window|#{window_index}]#{?window_active,#[bg=#b5bd68]#[fg=colour235]#[bold],#[bg=colour235]#[fg=colour245]} #I:#W #[bg=colour235]#[fg=colour250]#[nobold]#[norange]}\
#[align=right,bg=colour235,fg=colour245]\
#{?pane_in_mode,\
#[fg=#b5bd68,bold]SCROLL #[fg=colour245]jk#[fg=colour250]↑↓ #[fg=colour245]du#[fg=colour250]半頁 #[fg=colour245]bf#[fg=colour250]頁 #[fg=colour245]/#[fg=colour250]検索 #[fg=colour245]v#[fg=colour250]選択 #[fg=colour245]y#[fg=colour250]コピー #[fg=colour245]q/Esc#[fg=colour250]戻 ,\
#{?#{==:#{client_key_table},root},\
#[fg=colour245]<C-p>#[fg=colour250]pane #[fg=colour245]<C-t>#[fg=colour250]tab #[fg=colour245]<C-n>#[fg=colour250]resize #[fg=colour245]<C-h>#[fg=colour250]move #[fg=colour245]<C-s>#[fg=colour250]scroll #[fg=colour245]<C-o>#[fg=colour250]session #[fg=colour245]<C-g>#[fg=colour250]lock ,\
#{?#{==:#{client_key_table},pane},\
#[fg=#b5bd68,bold]PANE #[fg=colour245]c#[fg=colour250]↓ #[fg=colour245]v#[fg=colour250]→ #[fg=colour245]hjkl#[fg=colour250]移動 #[fg=colour245]np#[fg=colour250]前後 #[fg=colour245]C-d#[fg=colour250]閉 #[fg=colour245]Esc#[fg=colour250]戻 ,\
#{?#{==:#{client_key_table},tab},\
#[fg=#b5bd68,bold]TAB #[fg=colour245]c#[fg=colour250]新規 #[fg=colour245]np#[fg=colour250]前後 #[fg=colour245]1-9#[fg=colour250]移動 #[fg=colour245]r#[fg=colour250]名変 #[fg=colour245]C-d#[fg=colour250]閉 #[fg=colour245]Esc#[fg=colour250]戻 ,\
#{?#{==:#{client_key_table},resize},\
#[fg=#b5bd68,bold]RESIZE #[fg=colour245]hjkl#[fg=colour250]拡大 #[fg=colour245]HJKL#[fg=colour250]縮小 #[fg=colour245]-=#[fg=colour250]上下 #[fg=colour245]Esc#[fg=colour250]戻 ,\
#{?#{==:#{client_key_table},move},\
#[fg=#b5bd68,bold]MOVE #[fg=colour245]hjkl#[fg=colour250]入替 #[fg=colour245]n/Tab#[fg=colour250]次へ #[fg=colour245]Esc#[fg=colour250]戻 ,\
#{?#{==:#{client_key_table},session},\
#[fg=#b5bd68,bold]SESSION #[fg=colour245]d#[fg=colour250]切離 #[fg=colour245]w#[fg=colour250]一覧 #[fg=colour245]s#[fg=colour250]新規 #[fg=colour245]r#[fg=colour250]名変 #[fg=colour245]Esc#[fg=colour250]戻 ,\
#{?#{==:#{client_key_table},locked},\
#[fg=colour208,bold]LOCKED #[fg=colour245]C-l#[fg=colour250]解除 ,\
#[fg=colour245]<C-p>#[fg=colour250]pane }}}}}}}}"

# viモードを有効化
setw -g mode-keys vi

# クリップボード連携（macOS）
if-shell "uname | grep -q Darwin" {
    bind -T copy-mode-vi y send -X copy-pipe-and-cancel "pbcopy"
    bind -T copy-mode-vi Enter send -X copy-pipe-and-cancel "pbcopy"
}

# ------------------------------------------------------------------------------
# デフォルトのキーバインドをクリア
# ------------------------------------------------------------------------------
unbind -a -T root
unbind -a -T prefix

# 基本的なprefix操作は残す
bind C-Space send-prefix
bind : command-prompt

# ------------------------------------------------------------------------------
# Zellij風モード切り替え（Ctrl+キーで各モードへ）
# rootテーブルからCtrl+キーでモードに入る
# ------------------------------------------------------------------------------

# Ctrl+g → lockedモード（キー入力をスルー）
bind -T root C-g switch-client -T locked

# Ctrl+h → moveモード（ペイン配置変更）
bind -T root C-h switch-client -T move

# Ctrl+n → resizeモード
bind -T root C-n switch-client -T resize

# Ctrl+o → sessionモード
bind -T root C-o switch-client -T session

# Ctrl+p → paneモード
bind -T root C-p switch-client -T pane

# Ctrl+s → scrollモード（copy-mode）
bind -T root C-s copy-mode

# Ctrl+t → tabモード（ウィンドウ操作）
bind -T root C-t switch-client -T tab

# Ctrl+q → 終了確認
bind -T root C-q confirm-before -p "tmuxを終了しますか? (y/n)" kill-server

# Ctrl+] → zshのbindkeyに任せる（.functionsで定義）

# ------------------------------------------------------------------------------
# lockedモード（Ctrl+lで解除）
# ------------------------------------------------------------------------------
bind -T locked C-l switch-client -T root

# ------------------------------------------------------------------------------
# paneモード
# ------------------------------------------------------------------------------
# c → 下にペインを分割
bind -T pane c split-window -v -c "#{pane_current_path}"

# v → 右にペインを分割
bind -T pane v split-window -h -c "#{pane_current_path}"

# n → 次のペインへ
bind -T pane n select-pane -t :.+

# p → 前のペインへ
bind -T pane p select-pane -t :.-

# h/j/k/l → ペイン移動（vim風）
bind -T pane h select-pane -L
bind -T pane j select-pane -D
bind -T pane k select-pane -U
bind -T pane l select-pane -R

# Ctrl+d → ペインを閉じる
bind -T pane C-d kill-pane

# モード切り替え
bind -T pane C-p switch-client -T root
bind -T pane C-t switch-client -T tab
bind -T pane Escape switch-client -T root
bind -T pane Enter switch-client -T root

# ------------------------------------------------------------------------------
# tabモード（ウィンドウ操作）
# ------------------------------------------------------------------------------
# 数字キーでウィンドウ移動
bind -T tab 1 select-window -t :1
bind -T tab 2 select-window -t :2
bind -T tab 3 select-window -t :3
bind -T tab 4 select-window -t :4
bind -T tab 5 select-window -t :5
bind -T tab 6 select-window -t :6
bind -T tab 7 select-window -t :7
bind -T tab 8 select-window -t :8
bind -T tab 9 select-window -t :9

# c → 新しいウィンドウ
bind -T tab c new-window -c "#{pane_current_path}"

# n → 次のウィンドウ
bind -T tab n next-window

# p → 前のウィンドウ
bind -T tab p previous-window

# r → ウィンドウ名変更
bind -T tab r command-prompt -I "#W" "rename-window '%%'"

# Ctrl+d → ウィンドウを閉じる
bind -T tab C-d kill-window

# モード切り替え
bind -T tab C-p switch-client -T pane
bind -T tab C-t switch-client -T root
bind -T tab Escape switch-client -T root
bind -T tab Enter switch-client -T root

# ------------------------------------------------------------------------------
# sessionモード
# ------------------------------------------------------------------------------
# d → デタッチ
bind -T session d detach-client

# w → セッション/ウィンドウ一覧（Zellijのsession-manager相当）
bind -T session w choose-tree -Zs

# s → 新しいセッション
bind -T session s command-prompt -p "新しいセッション名:" "new-session -s '%%'"

# r → セッション名変更
bind -T session r command-prompt -I "#S" "rename-session '%%'"

# モード切り替え
bind -T session C-o switch-client -T root
bind -T session C-p switch-client -T pane
bind -T session C-t switch-client -T tab
bind -T session Escape switch-client -T root
bind -T session Enter switch-client -T root

# ------------------------------------------------------------------------------
# resizeモード
# ------------------------------------------------------------------------------
# h/j/k/l → サイズ拡大（5セルずつ）
bind -T resize h resize-pane -L 5
bind -T resize j resize-pane -D 5
bind -T resize k resize-pane -U 5
bind -T resize l resize-pane -R 5

# H/J/K/L → サイズ縮小（5セルずつ）
bind -T resize H resize-pane -L 1
bind -T resize J resize-pane -D 1
bind -T resize K resize-pane -U 1
bind -T resize L resize-pane -R 1

# -/= → 全体的なリサイズ
bind -T resize - resize-pane -D 2
bind -T resize = resize-pane -U 2

# モード切り替え
bind -T resize C-n switch-client -T root
bind -T resize Escape switch-client -T root
bind -T resize Enter switch-client -T root

# ------------------------------------------------------------------------------
# moveモード（ペインの位置を入れ替え）
# ------------------------------------------------------------------------------
# h/j/k/l → ペインを移動
bind -T move h swap-pane -s '{left-of}'
bind -T move j swap-pane -s '{down-of}'
bind -T move k swap-pane -s '{up-of}'
bind -T move l swap-pane -s '{right-of}'

# n/tab → ペインを次と入れ替え
bind -T move n swap-pane -D
bind -T move Tab swap-pane -D

# モード切り替え
bind -T move C-h switch-client -T root
bind -T move Escape switch-client -T root
bind -T move Enter switch-client -T root

# ------------------------------------------------------------------------------
# copy-mode（scroll/searchモード相当）のカスタマイズ
# ------------------------------------------------------------------------------
# Zellijスタイルのスクロール操作
bind -T copy-mode-vi j send -X cursor-down
bind -T copy-mode-vi k send -X cursor-up
bind -T copy-mode-vi d send -X halfpage-down
bind -T copy-mode-vi u send -X halfpage-up
bind -T copy-mode-vi b send -X page-up
bind -T copy-mode-vi f send -X page-down
bind -T copy-mode-vi G send -X history-bottom
bind -T copy-mode-vi g send -X history-top

# 検索
bind -T copy-mode-vi / command-prompt -i -p "(search down)" "send -X search-forward-incremental \"%%%\""
bind -T copy-mode-vi ? command-prompt -i -p "(search up)" "send -X search-backward-incremental \"%%%\""
bind -T copy-mode-vi n send -X search-again
bind -T copy-mode-vi N send -X search-reverse

# 選択とコピー（viスタイル）
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi V send -X select-line
bind -T copy-mode-vi C-v send -X rectangle-toggle

# Escapeまたはqで終了
bind -T copy-mode-vi Escape send -X cancel
bind -T copy-mode-vi q send -X cancel

# Ctrl+sで終了（Zellijスタイル）
bind -T copy-mode-vi C-s send -X cancel

# ------------------------------------------------------------------------------
# マウス操作
# ------------------------------------------------------------------------------
# セッション名（左側）をクリックでセッション一覧を表示
bind -T root MouseDown1StatusLeft choose-tree -Zs

# ステータスバーのタブをクリックでウィンドウ切り替え
bind -T root MouseDown1Status select-window -t =

# クリックでペイン選択
bind -T root MouseDown1Pane select-pane -t = \; send-keys -M

# マウスドラッグで選択（自動的にcopy-modeに入る）
bind -T root MouseDrag1Pane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "copy-mode -M"

# ドラッグ終了時にクリップボードへコピー（macOS）
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel "pbcopy"

# ホイールスクロールでcopy-modeに入る
bind -T root WheelUpPane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "copy-mode -e"

# ------------------------------------------------------------------------------
# Alt+キー ショートカット（共通操作、Zellijのshared_except "locked"相当）
# ------------------------------------------------------------------------------
# Alt+-/= → リサイズ
bind -T root M-- resize-pane -D 2
bind -T root M-= resize-pane -U 2

# Alt+f → フローティング風（ペインのズーム切り替え）
bind -T root M-f resize-pane -Z

# ------------------------------------------------------------------------------
# 追加の便利なキーバインド（prefix経由）
# ------------------------------------------------------------------------------
# 設定ファイルのリロード
bind r source-file ~/dotfiles/src/.tmux.conf \; display "設定をリロードしました"

# ペイン同期切り替え
bind S setw synchronize-panes \; display "同期: #{?pane_synchronized,ON,OFF}"

# 新しいセッション
bind N command-prompt -p "新しいセッション名:" "new-session -s '%%'"
