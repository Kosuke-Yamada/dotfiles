#!/bin/bash
# claude-window-status - ウィンドウ内の全ペーンの状態を色付きシンボルで表示
#
# 使用方法: claude-window-status [window_id]
#   window_id を省略すると現在のウィンドウを対象とする
#
# 出力例: "#[fg=#9d74b0]▲#[fg=#248887]●" (2ペーン)
#
# シンボルと色:
#   ▲ Claude Code:
#     マゼンタ - permission_prompt (許可待ち)
#     グレー   - idle_prompt (入力待ち)
#     イエロー - run_prompt (処理中)
#   ● 通常シェル:
#     イエロー - コマンド実行中
#     シアン   - コマンド終了（成功/エラー共通）
#
# 色は claude-hook-config で定義されています

# 共通設定を読み込む
SCRIPT_DIR="$(dirname "$0")"
# shellcheck source=claude-hook-config
source "$SCRIPT_DIR/claude-hook-config"

WINDOW_ID="${1:-}"
CLAUDE_PANE_STATUS="$SCRIPT_DIR/claude-pane-status"

# ウィンドウ内のペーン一覧を取得
if [[ -n "$WINDOW_ID" ]]; then
    PANES=$(tmux list-panes -t "$WINDOW_ID" -F '#{pane_id}' 2>/dev/null)
else
    PANES=$(tmux list-panes -F '#{pane_id}' 2>/dev/null)
fi

[[ -z "$PANES" ]] && exit 0

# シェル状態ファイルを読み取る関数
get_shell_status() {
    local pane_id="$1"
    local state_file="$CLAUDE_STATE_DIR/shell-${pane_id#%}"
    if [[ -f "$state_file" ]]; then
        cat "$state_file" 2>/dev/null
    else
        echo "idle"
    fi
}

OUTPUT=""
for pane in $PANES; do
    STATUS=$("$CLAUDE_PANE_STATUS" "$pane" 2>/dev/null)
    case "$STATUS" in
        permission_prompt)
            # Claude: 許可待ち（マゼンタ▲）
            OUTPUT+="#[fg=${COLOR_PERMISSION}]▲"
            ;;
        idle_prompt)
            # Claude: 入力待ち（グレー▲）
            OUTPUT+="#[fg=${COLOR_IDLE}]▲"
            ;;
        run_prompt)
            # Claude: 処理中（シアン▲）
            OUTPUT+="#[fg=${COLOR_RUN}]▲"
            ;;
        *)
            # 通常シェル: 状態に応じて色を変更（●）
            SHELL_STATUS=$(get_shell_status "$pane")
            case "$SHELL_STATUS" in
                running)
                    # 実行中: イエロー
                    OUTPUT+="#[fg=${COLOR_SHELL_RUNNING}]●"
                    ;;
                *)
                    # 実行していない（成功/エラー共通）: シアン
                    OUTPUT+="#[fg=${COLOR_SHELL_IDLE}]●"
                    ;;
            esac
            ;;
    esac
done

echo "$OUTPUT"
